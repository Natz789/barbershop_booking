<!-- booking/templates/booking/appointment_detail.html - VERIFIED FIXED -->
{% extends 'base/base.html' %}
{% load static %}
{% block title %}Appointment #{{ appointment.id }} - Barbershop{% endblock %}
{% block content %}
<div style="margin-bottom: 2rem;">
    <h1> Appointment Details #{{ appointment.id }}</h1>
    <span class="badge badge-{{ appointment.status }}" style="font-size: 1rem; padding: 0.5rem 1rem;">{{
        appointment.get_status_display }}</span>
</div>
<div style="max-width: 900px; margin: 0 auto;">
    <div class="grid grid-2">
        <div class="card">
            <h3> Customer Information</h3>
            <hr>
            <p><strong>Name:</strong> {{ appointment.customer.username }}</p>
            <p><strong>Email:</strong> {{ appointment.customer.email|default:"Not provided" }}</p>
        </div>
        <div class="card">
            <h3> Barber Information</h3>
            <hr>
            <p><strong>Name:</strong> {{ appointment.barber.name }}</p>
            <p><strong>Specialization:</strong> {{ appointment.barber.specialization|default:"General" }}</p>
        </div>
    </div>
    <div class="grid grid-2">
        <div class="card">
            <h3> Service Details</h3>
            <hr>
            <p><strong>Service:</strong> {{ appointment.service.name }}</p>
            <p><strong>Duration:</strong> {{ appointment.service.duration_minutes }} minutes</p>
            <p><strong>Price:</strong> <span
                    style="color: var(--secondary-color); font-size: 1.5rem; font-weight: bold;">{{
                    appointment.service.price }}</span></p>
        </div>
        <div class="card">
            <h3> Appointment Schedule</h3>
            <hr>
            <p><strong>Date:</strong> {{ appointment.appointment_date|date:"l, F d, Y" }}</p>
            <p><strong>Time:</strong> {{ appointment.appointment_time|time:"g:i A" }}</p>
            <p><strong>Booked on:</strong> {{ appointment.created_at|date:"M d, Y g:i A" }}</p>
        </div>
    </div>
    {% if appointment.notes %}<div class="card">
        <h3> Special Notes</h3>
        <hr>
        <p style="background: #f8f9fa; padding: 1rem; border-radius: 6px;">{{ appointment.notes }}</p>
    </div>{% endif %}
    <div class="card">
        <h3> Payment Information</h3>
        <hr>
        {% if appointment.payment %}
        <div class="grid grid-2">
            <div>
                <p><strong>Method:</strong> {{ appointment.payment.get_payment_method_display }}</p>
                <p><strong>Amount:</strong> {{ appointment.payment.amount }}</p>
                <p><strong>Status:</strong> <span class="badge badge-{{ appointment.payment.payment_status }}">{{
                        appointment.payment.get_payment_status_display }}</span></p>
            </div>
            <div>{% if appointment.payment.gcash_reference %}<p><strong>GCash Reference:</strong> {{
                    appointment.payment.gcash_reference }}</p>{% endif %}{% if appointment.payment.paid_at %}<p>
                    <strong>Paid At:</strong> {{ appointment.payment.paid_at|date:"M d, Y g:i A" }}</p>{% endif %}</div>
        </div>
        {% if user.is_staff and appointment.payment.payment_status == 'pending' %}<div
            style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);"><a
                href="{% url 'payments:mark_as_paid' appointment.payment.pk %}" class="btn btn-success">Mark as Paid</a>
        </div>{% endif %}
        {% else %}<p>No payment information available.</p>{% endif %}
    </div>
    <div class="card">
        <h3> Actions</h3>
        <hr>
        <div class="btn-group">
            {% if user.is_staff %}
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                {% if appointment.status == 'pending' %}
                <a href="{% url 'booking:approve_appointment' appointment.pk %}" class="btn btn-success">Approve
                    Appointment</a>
                <a href="{% url 'booking:decline_appointment' appointment.pk %}" class="btn btn-danger">Decline
                    Appointment</a>
                {% elif appointment.status == 'confirmed' %}
                {% if appointment.payment and appointment.payment.payment_status == 'paid' %}
                <a href="{% url 'booking:complete_appointment' appointment.pk %}" class="btn btn-primary">Complete
                    Appointment</a>
                {% else %}
                <p style="color: var(--warning-color); font-weight: bold;">Waiting for payment to be recorded before
                    completion.</p>
                {% if appointment.payment %}
                <a href="{% url 'payments:mark_as_paid' appointment.payment.pk %}" class="btn btn-warning">Mark as
                    Paid</a>
                {% endif %}
                {% endif %}
                {% endif %}
            </div>
            {% endif %}
            {% if user.is_staff %}
            <a href="{% url 'dashboard:admin_appointments' %}" class="btn btn-secondary"> Back to All Appointments</a><a
                href="{% url 'dashboard:home' %}" class="btn btn-secondary"> Dashboard</a>
            {% else %}<a href="{% url 'booking:my_appointments' %}" class="btn btn-secondary"> Back to My
                Appointments</a>{% endif %}
            {% if appointment.status == 'pending' or appointment.status == 'confirmed' %}<a
                href="{% url 'booking:cancel_appointment' appointment.pk %}" class="btn btn-danger">Cancel
                Appointment</a>{% endif %}
        </div>
    </div>
</div>
{% endblock %}